# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_gene_v2.2.h5"
extracted_expression_file = "SOX2 Up_similar_expression_matrix.tsv"
url = "https://s3.dev.maayanlab.cloud/archs4/files/human_gene_v2.2.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM2807074","GSM4387206","GSM4801481","GSM3073511","GSM2552906","GSM2241559","GSM2332858","GSM4518589","GSM1619508","GSM4075710","GSM2358333","GSM4038630","GSM3137499","GSM1863646","GSM3891869","GSM3091281","GSM3190602","GSM3189290","GSM4075651","GSM4753138","GSM3738990","GSM1467808","GSM3567658","GSM2579341","GSM3399782","GSM4118513","GSM2971198","GSM3905353","GSM2263381","GSM3122663","GSM2241555",
"GSM2092936","GSM3936266","GSM1467832","GSM3193310","GSM2643158","GSM2092975","GSM4631031","GSM4645642","GSM3073576","GSM4906866","GSM5027125","GSM3122582","GSM1703231","GSM2755633","GSM5158882","GSM4885751","GSM4631045","GSM3399837","GSM2575024","GSM3190692","GSM4772571","GSM2886352","GSM2701925","GSM3189101","GSM2411372","GSM5021333","GSM3189115","GSM4631057","GSM4106632","GSM3122622",
"GSM4871539","GSM2388706","GSM3189438","GSM2093152","GSM3399830","GSM4079176","GSM4772275","GSM1641339","GSM4871605","GSM3189375","GSM4489347","GSM2643168","GSM5050483","GSM2236216","GSM3520170","GSM3612175","GSM2807082","GSM5360974","GSM5397110","GSM3206925","GSM4613215","GSM3011815","GSM3439994","GSM4958020","GSM3759245","GSM3189296","GSM2754684","GSM3520132","GSM1297626","GSM3265080",
"GSM5360930","GSM4610289","GSM2241824","GSM2909559","GSM5361057","GSM4772590","GSM3189367","GSM3405993","GSM2332847","GSM4623629","GSM2910942","GSM4772648","GSM4146253","GSM3534422","GSM2332831","GSM3073551","GSM3840011","GSM3190511","GSM2370124","GSM4906865","GSM3527135","GSM4363402","GSM2987531","GSM4363422","GSM2992332","GSM1467824","GSM4588103","GSM2332790","GSM3190842","GSM3728314",
"GSM3840012","GSM1467823","GSM3612159","GSM3190695","GSM4683596","GSM3936237","GSM1863701","GSM3189471","GSM1133681","GSM4079175","GSM3189097","GSM2886201","GSM3073476","GSM3714555","GSM2987527","GSM3559671","GSM4319603","GSM3122584","GSM2755626","GSM3348312","GSM4319580","GSM2256664","GSM3190889","GSM4885928","GSM4753132","GSM4871691","GSM3534221","GSM5216261","GSM1868771","GSM2828595",
"GSM4976260","GSM1467814","GSM2477388","GSM3399802","GSM4118495","GSM4974419","GSM2093038","GSM4772550","GSM2275135","GSM3525908","GSM3840003","GSM4588104","GSM1647004","GSM2987523","GSM3754713","GSM5025826","GSM3045788","GSM2987503","GSM2263385","GSM2275093","GSM3534239","GSM3891870","GSM2332837","GSM5361052","GSM2178352","GSM5174356","GSM3190669","GSM4363392","GSM3839996","GSM4034746",
"GSM4752725","GSM3711325","GSM3122579","GSM5172394","GSM5025824","GSM4776578","GSM4610342","GSM4923260","GSM2031983","GSM2532895","GSM3686475","GSM1647095","GSM3587215","GSM3308523","GSM2720263","GSM4753079","GSM3011809","GSM3043170","GSM3073516","GSM3534098","GSM3190880","GSM1868769","GSM4772277","GSM4913660","GSM3860982","GSM4552789","GSM2275150","GSM3534172","GSM3122623","GSM3399788",
"GSM3983059","GSM4871613","GSM4756847","GSM4038636","GSM4319389","GSM4923263","GSM1868726","GSM2987518","GSM4696797","GSM4610356","GSM2332830","GSM4609398","GSM5174249","GSM1467804","GSM5111123","GSM3728324","GSM1467797","GSM3073474","GSM2326913","GSM3189270","GSM3754711","GSM3936248","GSM2770082","GSM2479720","GSM1240654","GSM2170915","GSM4319533","GSM4772359","GSM4075679","GSM2370231",
"GSM4485279","GSM4870255","GSM4207186","GSM2236289","GSM4923254","GSM4753142","GSM2720264","GSM3057822","GSM2093214","GSM3091342","GSM4495738","GSM3189263","GSM2834967","GSM3612171","GSM2275125","GSM4610278","GSM2550590","GSM3308524","GSM3011807","GSM4645811","GSM2987500","GSM4118456","GSM5092004","GSM3190694","GSM2909558","GSM3892137","GSM4079183","GSM4080764","GSM2770147","GSM1619490",
"GSM3091452","GSM2267072","GSM3612178","GSM2141290","GSM1896141","GSM3402006","GSM3447524","GSM2358336","GSM4913633","GSM3091316","GSM4801500","GSM1377957","GSM4002736","GSM3762717","GSM4871625","GSM4871550","GSM3265041","GSM2330171","GSM4038629","GSM2755947","GSM2274934","GSM1467799","GSM3211177","GSM3189169","GSM3189259","GSM3189443","GSM3316322","GSM5174366","GSM3189116","GSM4610357",
"GSM2987501","GSM4772229","GSM3122589","GSM3073404","GSM5158986","GSM4974425","GSM3818335","GSM4610340","GSM3091466","GSM3399772","GSM4552777","GSM3189410","GSM4610338","GSM4871565","GSM3399783","GSM3091269","GSM2388732","GSM3091279","GSM1868793","GSM4871531","GSM3091339","GSM4753116","GSM5397117","GSM3896877","GSM3122592","GSM3509042","GSM5158933","GSM2477387","GSM3011812","GSM3043735",
"GSM3043716","GSM3819895","GSM3122583","GSM4118528","GSM3399810","GSM3091474","GSM4753095","GSM2388740","GSM4752673","GSM3122575","GSM5008509","GSM4645657","GSM1467790","GSM3189291","GSM4923267","GSM3711255","GSM2992286","GSM2987519","GSM4610358","GSM3043174","GSM2299859","GSM5091961","GSM3891807","GSM2332883","GSM4725998","GSM4631017","GSM2072174","GSM5174359","GSM1703071","GSM5418414",
"GSM3534352","GSM4610365","GSM4489163","GSM3122566","GSM3043189","GSM4871597","GSM3073439","GSM3346622","GSM4972306","GSM4648997","GSM5418331","GSM3983145","GSM4631036","GSM3527041","GSM4118540","GSM3896836","GSM3505053","GSM3190545","GSM2388659","GSM4871638","GSM3534164","GSM3728329","GSM2449439","GSM3936255","GSM3190675","GSM2987513","GSM3728340","GSM4772284","GSM4915885","GSM5050485",
"GSM5360884","GSM3520142","GSM3721341","GSM4118471","GSM3189407","GSM3091273","GSM1621318","GSM3763201","GSM1703213","GSM5174361","GSM2275068","GSM3045786","GSM3043666","GSM2755754","GSM3189293","GSM2370235","GSM4776575","GSM3728327","GSM3754155","GSM3728313","GSM4459722","GSM1621317","GSM5361007","GSM3189162","GSM3891857","GSM1726611","GSM4980107","GSM2449421","GSM2332834","GSM4753110",
"GSM5273483","GSM4489414","GSM4915886","GSM4095253","GSM5397108","GSM2241562","GSM3534224","GSM3508711","GSM3091457","GSM3288225","GSM1863653","GSM3527142","GSM3534409","GSM3527299","GSM4772739","GSM4118466","GSM2370437","GSM4752678","GSM3612163","GSM2388704","GSM4319301","GSM4753131","GSM5273459","GSM4772506","GSM3319623","GSM2332865","GSM4923253","GSM2275161","GSM5174364","GSM2332820",
"GSM5241768","GSM3057848","GSM2332840","GSM5360868","GSM3122620","GSM4363452","GSM4850473","GSM4453524","GSM5281149","GSM4286093","GSM4871547","GSM4631007","GSM4118508","GSM1619483","GSM2332863","GSM3728316","GSM2228273","GSM3860946","GSM2388746","GSM4915636","GSM3335821","GSM3190791","GSM4871585","GSM3190604","GSM4038625","GSM2326892","GSM4518580","GSM1704373","GSM4772287","GSM2479718",
"GSM1703739","GSM4201241","GSM3265202","GSM3073530","GSM4871553","GSM3506232","GSM2263407","GSM4092082","GSM3122558","GSM3073450","GSM4363423","GSM4871634","GSM4429966","GSM2332890","GSM4753140","GSM3011824","GSM3612164","GSM3091283","GSM3189095","GSM2092944","GSM4915644","GSM3265083","GSM4730578","GSM2828615","GSM4776573","GSM3073407","GSM2770105","GSM4753109","GSM3728342","GSM4710672",
"GSM3936252","GSM2332818","GSM3936316","GSM3091472","GSM3397169","GSM3122580","GSM1467805","GSM3728346","GSM3399784","GSM4871616","GSM1868770","GSM2755963","GSM2743853","GSM3711259","GSM3447460","GSM2275108","GSM3520122","GSM3091422","GSM3122581","GSM1646960","GSM1467783","GSM4710677","GSM3728328","GSM2987524","GSM3265099","GSM4223378","GSM1467829","GSM1941368","GSM2253370","GSM3190840",
"GSM3785341","GSM4610367","GSM3818333","GSM4753118","GSM3189267","GSM4871572","GSM4002742","GSM4552780","GSM1868773","GSM4610359","GSM3714541","GSM1868734","GSM3527039","GSM4776581","GSM5385255","GSM2449442","GSM5351090","GSM3091336","GSM4610293","GSM4075708","GSM1467835","GSM3100285","GSM5241770","GSM2886206","GSM4772542","GSM3728333","GSM4871599","GSM5418379","GSM3785349","GSM3122611",
"GSM4753128","GSM3073528","GSM4752642","GSM4002746","GSM2388738","GSM2987525","GSM4923266","GSM4363404","GSM2332791","GSM4752714","GSM4075724","GSM3534430","GSM3840013","GSM3511740","GSM2479721","GSM2275122","GSM3189313","GSM3397188","GSM3759253","GSM2241841","GSM2987510","GSM1556182","GSM2241556","GSM3189094","GSM3091340","GSM4923256","GSM5360936","GSM5241769","GSM3122573","GSM2326907",
"GSM3527157","GSM5273463","GSM3122562","GSM4906863","GSM3728320","GSM4871664","GSM3839759","GSM3534412","GSM4363383","GSM3265199","GSM2388743","GSM3189255","GSM4753098","GSM3073401","GSM4631012","GSM4363380","GSM4923271","GSM5397104","GSM4769155","GSM3122564","GSM3520147","GSM2828596","GSM4319647","GSM4495739","GSM4753143","GSM4363381","GSM4753126","GSM5124396","GSM2263372","GSM2332885",
"GSM4753135","GSM4610295","GSM3711312","GSM5106055","GSM4915887","GSM869034","GSM4776583","GSM1562528","GSM1966676","GSM2828583","GSM2755383","GSM5397105","GSM2620886","GSM4038619","GSM4075674","GSM3936317","GSM3612165","GSM3091278","GSM5397111","GSM3122598","GSM2828619","GSM4753145","GSM1467802","GSM1868733","GSM3612187","GSM3508762","GSM3983055","GSM3043761","GSM2756059","GSM3091304",
"GSM3896835","GSM3122597","GSM1562797","GSM3043767","GSM3728345","GSM4118536","GSM4610352","GSM4913614","GSM3399778","GSM2987511","GSM4923259","GSM5009915","GSM3091325","GSM5273481","GSM3091313","GSM3206924","GSM2987514","GSM3711303","GSM3043750","GSM3508763","GSM3122596","GSM5273472","GSM2332894","GSM1562405","GSM1966554","GSM2360266","GSM3534419","GSM4871623","GSM4610366","GSM4871653",
"GSM3936273","GSM3711261","GSM3122587","GSM3728344","GSM3728321","GSM4958975","GSM3518022","GSM4363445","GSM4426268","GSM3073388","GSM3091328","GSM5362286","GSM3936231","GSM2828591","GSM4753121","GSM4363412","GSM4923272","GSM2263388","GSM4915626","GSM2326915","GSM3936281","GSM3122588","GSM4391753","GSM4363407","GSM4038626","GSM3091448","GSM2987499","GSM4518570","GSM3728339","GSM3728322",
"GSM3265076","GSM4363393","GSM5087154","GSM3122615","GSM4363389","GSM4752716","GSM2755780","GSM3122896","GSM4610351","GSM5027126","GSM2275154","GSM4753117","GSM3265069","GSM5027127","GSM4871675","GSM3073501","GSM4753122","GSM3728347","GSM4801462","GSM4387187","GSM3896845","GSM2411353","GSM4363405","GSM1717162","GSM4610350","GSM5065327","GSM3896824","GSM3190544","GSM4753066","GSM4923249",
"GSM3612183","GSM5418401","GSM4075675","GSM3728326","GSM3896819","GSM1087883","GSM4118469","GSM2332891","GSM3860955","GSM4871681","GSM3091469","GSM3091314","GSM2756008","GSM3612184","GSM3189432","GSM4753139","GSM3045785","GSM4801497","GSM2828585","GSM3137631","GSM3399759","GSM1861846","GSM2828618","GSM4753125","GSM2332857","GSM4363398","GSM5360891","GSM4363395","GSM3122585","GSM4118491",
"GSM4913655","GSM3896831","GSM1868762","GSM4138481","GSM2828614","GSM3265030","GSM4753146","GSM3612181","GSM3122616","GSM2332889","GSM4923270","GSM1966739","GSM1562591","GSM1861847","GSM2828575","GSM2828570","GSM3728332","GSM4118472","GSM3860996","GSM4610294","GSM4552778","GSM4363384","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/symbol")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

