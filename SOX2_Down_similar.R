# R script to download selected samples
# Copy code and run on a local machine to initiate download

library("rhdf5")    # can be installed using Bioconductor

destination_file = "human_gene_v2.2.h5"
extracted_expression_file = "SOX2_Down_similar_expression_matrix.tsv"
url = "https://s3.dev.maayanlab.cloud/archs4/files/human_gene_v2.2.h5"

# Check if gene expression file was already downloaded, if not in current directory download file form repository
if(!file.exists(destination_file)){
    print("Downloading compressed gene expression matrix.")
    download.file(url, destination_file, quiet = FALSE, mode = 'wb')
}

# Selected samples to be extracted
samp = c("GSM3570573","GSM2289790","GSM2247033","GSM2318341","GSM2979399","GSM2374773","GSM3568466","GSM2493361","GSM3136012","GSM2824579","GSM2313139","GSM1914615","GSM3214572","GSM2153740","GSM5217386","GSM3568415","GSM2492994","GSM2316631","GSM2492678","GSM2980035","GSM2317376","GSM3527375","GSM4840117","GSM3146864","GSM2268707","GSM4139945","GSM2318264","GSM4253669","GSM4696645","GSM3549867","GSM2312240",
"GSM5044820","GSM2642115","GSM3552507","GSM2493413","GSM2271662","GSM4050200","GSM2413492","GSM2451138","GSM2455922","GSM4684243","GSM4139747","GSM2665968","GSM3504719","GSM3527642","GSM2456403","GSM2153691","GSM3504698","GSM2289789","GSM3527749","GSM3214721","GSM3392233","GSM2641729","GSM2317969","GSM3527382","GSM3254743","GSM2456271","GSM2492761","GSM2455943","GSM2749807","GSM3527752",
"GSM2154015","GSM2316556","GSM3527607","GSM2494535","GSM2313781","GSM3570737","GSM3527966","GSM2894232","GSM4161849","GSM3350733","GSM4327175","GSM2493668","GSM2313133","GSM4129850","GSM5044945","GSM3567880","GSM3570801","GSM3345793","GSM2374804","GSM4334832","GSM2268855","GSM2492847","GSM2599495","GSM2455981","GSM1914574","GSM3340152","GSM4376259","GSM4839644","GSM3146778","GSM2456478",
"GSM3047647","GSM2616433","GSM1957555","GSM3241032","GSM2750704","GSM1810645","GSM4606826","GSM4702444","GSM4335323","GSM2561443","GSM3339212","GSM2244514","GSM3252044","GSM3527808","GSM2492920","GSM2317325","GSM4839825","GSM2317439","GSM3848664","GSM3502052","GSM3241103","GSM2841364","GSM2269088","GSM2316763","GSM2749780","GSM3504715","GSM2666042","GSM3572048","GSM4052741","GSM3388184",
"GSM3527725","GSM2492891","GSM4139871","GSM5045299","GSM3342179","GSM3570871","GSM3570107","GSM3345832","GSM5103876","GSM2317077","GSM4253515","GSM2154402","GSM2492660","GSM3739733","GSM2451104","GSM5103845","GSM2269368","GSM2739414","GSM4839949","GSM2456261","GSM4840639","GSM3848627","GSM4840500","GSM3572670","GSM3253130","GSM3527716","GSM3527505","GSM2749030","GSM4839908","GSM2456029",
"GSM3344194","GSM3527830","GSM2493005","GSM2493661","GSM1957485","GSM2493349","GSM5103615","GSM4427383","GSM2514350","GSM3567827","GSM5149740","GSM3397898","GSM3739989","GSM3626516","GSM3527758","GSM5151641","GSM2492708","GSM4117743","GSM4701808","GSM3397843","GSM3739516","GSM2493167","GSM3512987","GSM4333574","GSM2749918","GSM2289606","GSM2316605","GSM3527856","GSM3388074","GSM3590240",
"GSM5104010","GSM5103989","GSM4701818","GSM2749476","GSM2269000","GSM2666267","GSM2455675","GSM3568438","GSM3550196","GSM4775794","GSM3249005","GSM5103994","GSM2316821","GSM2270265","GSM3345221","GSM2271113","GSM3849466","GSM2171007","GSM2313053","GSM2158614","GSM2665959","GSM3136079","GSM3253461","GSM3527664","GSM4324216","GSM2665702","GSM2317492","GSM2153466","GSM2316783","GSM3932181",
"GSM2641863","GSM3136500","GSM1957513","GSM2316937","GSM3137049","GSM2451087","GSM2492917","GSM3214449","GSM1957674","GSM2451174","GSM3137128","GSM2313636","GSM2456601","GSM3350591","GSM2312721","GSM4839487","GSM4840257","GSM2269301","GSM2159208","GSM3080603","GSM3323908","GSM3345368","GSM5149802","GSM3345430","GSM2317983","GSM3388190","GSM4129081","GSM5103859","GSM3343514","GSM4475261",
"GSM3512635","GSM4248323","GSM2454055","GSM3162759","GSM3627003","GSM4325477","GSM2492765","GSM5103928","GSM3739384","GSM4839220","GSM3527914","GSM4139745","GSM2312513","GSM3569658","GSM2245028","GSM2493337","GSM3146732","GSM2494620","GSM2318316","GSM2313953","GSM2492858","GSM5103695","GSM3527848","GSM3502088","GSM2493657","GSM2831857","GSM5149597","GSM2455889","GSM2451195","GSM2268502",
"GSM2455804","GSM2526826","GSM3388144","GSM2456014","GSM3527413","GSM3933772","GSM2153421","GSM2519876","GSM5151476","GSM1914607","GSM2455918","GSM3388198","GSM3345398","GSM2313887","GSM2246795","GSM3309527","GSM3485022","GSM2318249","GSM2455586","GSM4248070","GSM2287053","GSM4324196","GSM2641382","GSM3345183","GSM3590114","GSM2824825","GSM2244102","GSM3486332","GSM2493412","GSM3329408",
"GSM3389796","GSM3270232","GSM4334329","GSM5149559","GSM3214437","GSM3328888","GSM2158535","GSM4023972","GSM2312252","GSM5149770","GSM2979731","GSM2153324","GSM2456841","GSM3485039","GSM2318101","GSM3162781","GSM3215152","GSM3484932","GSM3329294","GSM3344937","GSM2317623","GSM4139935","GSM2642046","GSM2316728","GSM2313396","GSM5104002","GSM2269113","GSM2316653","GSM4839153","GSM2317974",
"GSM1624822","GSM2526904","GSM2749625","GSM3568305","GSM2610773","GSM4161648","GSM2316539","GSM4130503","GSM3527766","GSM2317567","GSM2641540","GSM2245472","GSM4129018","GSM3329409","GSM3251391","GSM4984131","GSM2456401","GSM2317055","GSM2316943","GSM2493310","GSM3392197","GSM3527435","GSM2979349","GSM2166318","GSM2494490","GSM2493429","GSM4840531","GSM3548793","GSM5103721","GSM2174213",
"GSM2455936","GSM3389836","GSM3486526","GSM2316757","GSM2993584","GSM4334758","GSM5103759","GSM2494450","GSM2451052","GSM3527407","GSM4813665","GSM2154109","GSM3527478","GSM2455805","GSM2456319","GSM3527498","GSM3568014","GSM2316676","GSM3527610","GSM3485066","GSM2271245","GSM3346022","GSM1957743","GSM2678743","GSM3527500","GSM3345570","GSM3450079","GSM2455946","GSM5113354","GSM3568401",
"GSM3527764","GSM4104786","GSM2317930","GSM3485347","GSM4775980","GSM3484941","GSM3527746","GSM2457297","GSM3253263","GSM4139719","GSM3940897","GSM3344974","GSM3851310","GSM3162719","GSM3215086","GSM3528131","GSM4262651","GSM4563472","GSM1241161","GSM2317066","GSM2269191","GSM4247876","GSM2610771","GSM4335056","GSM2455813","GSM3571782","GSM2492731","GSM2317124","GSM5103609","GSM2492781",
"GSM2456528","GSM2992844","GSM2456363","GSM2641705","GSM4139842","GSM2316947","GSM3250057","GSM2316554","GSM2642093","GSM2316586","GSM3527560","GSM5149617","GSM2317089","GSM2451048","GSM2153595","GSM2316957","GSM4702414","GSM3345682","GSM3527674","GSM2641914","GSM2246041","GSM2457206","GSM2317298","GSM2826613","GSM2317132","GSM2316892","GSM3174654","GSM3512261","GSM2616404","GSM2641801",
"GSM3345241","GSM3215096","GSM3527477","GSM2493428","GSM2316898","GSM2317541","GSM3486303","GSM2456235","GSM2317415","GSM3350592","GSM4947909","GSM2289212","GSM2317413","GSM2312669","GSM3527535","GSM4839552","GSM4104831","GSM3527476","GSM5103642","GSM3527363","GSM2316782","GSM2493658","GSM4840080","GSM2610788","GSM3527471","GSM2831767","GSM2874318","GSM2312250","GSM2317004","GSM3439567",
"GSM4320586","GSM2492820","GSM3527719","GSM3345235","GSM5149611","GSM2289963","GSM3388203","GSM3528070","GSM2312242","GSM4326372","GSM5103684","GSM2153321","GSM2153419","GSM2455769","GSM2526796","GSM5103620","GSM2451075","GSM2154574","GSM2317017","GSM2317650","GSM3568445","GSM2748962","GSM4753326","GSM2456562","GSM2154070","GSM2316889","GSM2373970","GSM3253585","GSM5361953","GSM2980677",
"GSM3338410","GSM2316986","GSM2455838","GSM4023893","GSM2153662","GSM3502072","GSM3527554","GSM2174731","GSM3329311","GSM3389845","GSM2318150","GSM3527551","GSM4139921","GSM4840131","GSM2455595","GSM2316604","GSM3527669","GSM2317421","GSM4139708","GSM2313891","GSM4104872","GSM3485035","GSM5151602","GSM2456010","GSM2316705","GSM5103694","GSM2325830","GSM3513307","GSM3569636","GSM2166369",
"GSM925614","GSM4104942","GSM3527490","GSM2547439","GSM5103717","GSM2316678","GSM2492844","GSM3527572","GSM2610782","GSM4334631","GSM3527753","GSM2519822","GSM3527462","GSM2519847","GSM3603445","GSM3527774","GSM5149820","GSM2316997","GSM2317002","GSM1957434","GSM5103726","GSM2492647","GSM2493425","GSM2980422","GSM2268736","GSM2317061","GSM3345448","GSM3527770","GSM5103619","GSM3420787",
"GSM2456450","GSM4104829","GSM2316921","GSM2318204","GSM2316975","GSM2455629","GSM2456055","GSM2317970","GSM3527369","GSM2493430","GSM2492681","GSM3527543","GSM2318220","GSM4335160","GSM3214702","GSM2316955","GSM3527846","GSM3569608","GSM3851848","GSM5384413","GSM2317654","GSM3345553","GSM2317070","GSM2316738","GSM3247272","GSM2154502","GSM2456972","GSM5103629","GSM3527748","GSM2316995",
"GSM2312781","GSM4104825","GSM3527372","GSM4799106","GSM2154303","GSM2317456","GSM2632584","GSM3527494","GSM2269085","GSM2979035","GSM2317924","GSM2153299","GSM2316794","")

# Retrieve information from compressed data
samples = h5read(destination_file, "meta/samples/geo_accession")
genes = h5read(destination_file, "meta/genes/symbol")

# Identify columns to be extracted
sample_locations = which(samples %in% samp)

# extract gene expression from compressed data
expression = t(h5read(destination_file, "data/expression", index=list(sample_locations, 1:length(genes))))
H5close()
rownames(expression) = genes
colnames(expression) = samples[sample_locations]

# Print file
write.table(expression, file=extracted_expression_file, sep="\t", quote=FALSE, col.names=NA)
print(paste0("Expression file was created at ", getwd(), "/", extracted_expression_file))

